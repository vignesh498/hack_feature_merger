```markdown
## Feature Implementation Analysis: Holiday Management

### 1. Feature Overview:

This feature allows airline users to define and manage holiday lists, including non-business days, within the GroupRM application. When processing group booking requests, the system checks if fare, payment, or name list validities expire on a holiday. If a validity falls on a holiday, the system can alert the user to adjust the validity dates or, in the case of autopilot policies, automatically shift the validity to the next or previous working day. This ensures that validity periods align with actual business days.

### 2. Technical Changes:

The provided patch file includes changes across multiple files, addressing various aspects of the holiday management feature and related functionalities. Key technical changes include:

*   **index.php**: Adds logic to hide the deeplink header on the login page when accessing the domain directly with the `grmAccess` parameter.
*   **class.systemSetup.php**: Adds "payment\_expiry" to the list of fields for the "dashBoardNewCharts" configuration.
*   **class.getFareCheckDetails.php**: Fixes an issue with option count for fare check.
*   **class.common.php**: Modifies conditions for user data retrieval based on corporate ID and adds logic to retrieve the request master history ID for modify requests.
*   **class.deepLink.php**: Implements redirection logic for retail users after successful payment completion, handling cases where the request is already fully paid. Also includes OTP functionalities and payment master ID retrieval.
*   **class.processRequest.php**: Adds logic to check flight and seat availability from the service response and includes a function to remove through flights when checking seat availability.
*   **holiday\_calendar.js**: Hides the advanced search option when creating a new holiday.
*   **adhocGroupRequest.js**: Includes change iternary value in the form values
*   **class.tpl.holidayListInterface.php**: Modifies the validity data retrieval and validation process, incorporating holiday skip data and handling payment expiry date adjustments.
*   **class.tpl.timeLineExtensionV1.php**: Adjusts fare validity details based on days to departure.
*   **class.tpl.viewHistory.php**: Adds a method to set the request master history ID based on the request master ID and actual date.
*   **class.module.adhocGetQuoteRequest.php**: Includes change iternary value in the form values
*   **class.module.submitTigerPaymentRequest.php**: Adds a script to hide the content loader.
*   **class.module.menuV1.php**: Sets the deepLink object for menu redirection.
*   **en\_validation.conf**: Updates validation messages for passenger details.
*   **WN\_database.sql**: Includes updates to the system settings for minimum mobile number length and configuration to skip via flight numbers when checking seat availability.
*   **oauthSSO.php**: Unset deeplink session while login with grmAccess
*   **groupLevelTimelineExtensionExtJs.tpl**:Set validity type when it is empty
*   **createPassengerTemplateExtJs.tpl**: Updates validation messages for passenger details.
*   **WNHeader.tpl**: Conditionally renders the deeplink header based on session status and query parameters.

### 3. Implementation Mapping:

| BRD Requirement                                                                                                                                                                                                                            | Code Implementation                                                                                                                                                                                                                                                                                                                                                                                           |
| :------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | :-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| Airline user creates holiday list                                                                                                                                                                                                          | `classesTpl/class.tpl.holidayListInterface.php`, `lib/script/moduleJs/holiday_calendar.js` - Provides the UI and functionality for creating and managing holiday lists.                                                                                                                                                                                                                            |
| Application checks validities against holiday dates                                                                                                                                                                                          | `classesTpl/class.tpl.holidayListInterface.php` - Implements the logic to retrieve holiday data and validate validity periods against those dates.                                                                                                                                                                                                                                                       |
| Application blocks user with alert pop-up if validity expires on holiday                                                                                                                                                                   | `classesTpl/class.tpl.holidayListInterface.php` - Contains the logic to generate the alert message when a validity falls on a holiday.                                                                                                                                                                                                                                                                       |
| User can modify time limit matrix from contract manager                                                                                                                                                                                  | `classesTpl/class.tpl.timeLineExtensionV1.php`, `classesTpl/class.tpl.holidayListInterface.php` - Enables modification of validity periods through the contract manager interface, considering holiday information.                                                                                                                                                                                                         |
| Autopilot policy shifts validity to the following/prior working day                                                                                                                                                                      | `classesTpl/class.tpl.holidayListInterface.php` - Implements the logic to automatically adjust validity dates in autopilot mode, considering holiday and non-business day information.                                                                                                                                                                                                                               |
| Ensures validity changes apply only to the specific request                                                                                                                                                                               | This is implicitly handled through the request-specific context in which the validity modification logic operates within the `classesTpl/class.tpl.holidayListInterface.php` and related files.                                                                                                                                                                                                                               |
| Added configuration as mergeThroughFlights to skip the via flight number when checking the seatsAvailability                                                                                                                             | `classes/class.processRequest.php`- Implements function `_removeThroughFlights` to remove the through flights when checking the seatsAvailability based on configuration.                                                                                                                                                                                                                           |

### 4. Files Modified:

*   **index.php**: Handles deep linking and session management.
*   **classes/class.systemSetup.php**: Defines system configuration parameters.
*   **classes/class.getFareCheckDetails.php**: Handles fare check details and options.
*   **classes/class.common.php**: Provides common utility functions, including data retrieval and date manipulation.
*   **classes/class.deepLink.php**: Manages deep linking functionality, including authentication and redirection.
*   **classes/class.processRequest.php**: Processes booking requests, including validity checks and autopilot adjustments.
*   **lib/script/moduleJs/holiday\_calendar.js**: Implements client-side logic for the holiday management UI.
*   **lib/script/moduleJs/adhocGroupRequest.js**: Implements client-side logic for the Adhoc Group Request.
*   **classesTpl/class.tpl.holidayListInterface.php**: Contains the template logic for the holiday management interface, including validity checks and alert generation.
*   **classesTpl/class.tpl.timeLineExtensionV1.php**: Manages the timeline extension for validity periods.
*   **classesTpl/class.tpl.viewHistory.php**: Manages the view history details and sets the request master history id.
*   **classesModule/class.module.adhocGetQuoteRequest.php**: Implements server-side logic for the Adhoc Group Request.
*   **classesModule/class.module.submitTigerPaymentRequest.php**: Implements server-side logic for the submit Tiger Payment Request.
*   **classesModule/class.module.menuV1.php**: Manages the menu redirection.
*   **language/en\_language/en\_validation.conf**: Contains validation messages.
*   **database/WN\_database.sql**: Includes database updates, such as system settings.
*   **SSO/oauthSSO.php**: Handles SSO functionality, including authentication and session management.
*   **smarty/templates/groupLevelTimelineExtensionExtJs.tpl**: Manages the group level timeline extension.
*   **smarty/templates/createPassengerTemplateExtJs.tpl**: Manages the passenger template.
*   **plugins/WN/view/WNHeader.tpl**: Manages the header template.

### 5. Key Functions/Methods:

*   **`classesTpl/class.tpl.holidayListInterface.php`**:
    *   `_getAllValiditiestimeline()`: Retrieves validity timeline data.
    *   `_getHolidaySkipData()`: Determines if a validity should be skipped due to a holiday.
    *   `_validityCheckContract()`: Checks the contract validity against holiday dates and adjusts accordingly.
    *   `_reassignPaymentDetailsValueArr()`: Reconstruct paymentDetails array based on the paymentRequestDetails array
*   **`classes/class.processRequest.php`**:
    *    `_removeThroughFlights()`:  remove the through flights when checking the seatsAvailability based on configuration.
*   **`classes/class.deepLink.php`**:
    *   `_retailUserSuccessMsgRedirect()`: Handles redirection after successful retail user payment.
*   **`classesTpl/class.tpl.viewHistory.php`**:
    *   `_setRequestMasterHistoryId()`: Sets the request master history ID.

### 6. Implementation Guide:

1.  **Apply the Patch:** Apply the provided patch file to the codebase.
2.  **Database Updates:** Execute the SQL statements in `database/WN_database.sql` to update the system settings table.
3.  **Holiday List Creation:**
    *   Navigate to the Admin -> Holiday Management section in the GRM application.
    *   Click "Create Holiday."
    *   Enter the holiday name, country, city, year, and status.
    *   Select dates from the calendar and enter holiday names for each date.
    *   Define non-business hours of the week.
    *   Click "Save" to create the holiday list.
4.  **Testing:**
    *   Create a group booking request with validity dates that fall on a defined holiday.
    *   Approve the request as an airline user.
    *   Verify that the system displays an alert pop-up, blocking the approval until the validity date is adjusted.
    *   Test the autopilot policy to ensure that validities are automatically shifted to the next or previous working day when falling on a holiday.
5.  **Verify Deep Linking:**
    *   Test the deep linking functionality to ensure correct redirection and session management.
6.  **Verify Passenger Template:**
     *  Test the passenger template to ensure that the error message are displayed properly and no dependency field is missed.

### 7. Considerations:

*   **Edge Cases:** Consider edge cases such as holidays spanning multiple days or holidays falling on weekends. Ensure the logic correctly handles these scenarios.
*   **Dependencies:** The feature relies on the correct configuration of system settings, holiday lists, and contract manager settings. Verify these settings are properly configured.
*   **Time Zones:** Ensure that time zone conversions are handled correctly when determining validity expiry dates, especially for international travel.
*   **Performance:** Monitor the performance of the validity checking logic, especially for large group booking requests. Optimize the code as needed to prevent performance bottlenecks.
*   **Holiday Paid Status:** Ensure to consider the `holiday_paidStatus` in the holiday list to manage the validity check for the holidays.
*   **Through Flights:** Check the configuration for mergeThroughFlights in the system settings to avoid issues with the seatAvailability.
```